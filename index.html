<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Modern M3U IPTV Player</title>
  <style>
    :root{
      --bg:#0b0f14; --muted:#9aa4b2; --accent:#1db954; --glass: rgba(255,255,255,0.03); --text:#e6eef6;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    body{margin:0;background:#000;color:var(--text);}
    *{box-sizing:border-box}

    /* player */
    #playerWrap{position:fixed; inset:0; background:#000; z-index:40; display:flex; align-items:center; justify-content:center}
    #videoContainer{width:100%; height:100%; position:relative; background:#000}
    video{width:100%; height:100%; display:block; object-fit:contain}
    .overlay{position:absolute; left:14px; top:14px; display:flex; gap:12px; align-items:center; background:linear-gradient(90deg, rgba(0,0,0,0.45), rgba(0,0,0,0.25)); padding:10px 12px; border-radius:8px}
    .overlay .logo{width:56px; height:36px; background:rgba(255,255,255,0.1); border-radius:6px; display:flex; align-items:center; justify-content:center; overflow:hidden}
    .overlay .logo img{width:100%; height:100%; object-fit:contain}
    .current-info .title{font-weight:700}
    .current-info .num{color:var(--accent); font-size:14px}
    .controls{position:absolute; right:14px; top:14px; display:flex; gap:8px}
    .btn{background:var(--glass); padding:8px 10px; border-radius:8px; cursor:pointer}
    #btnMenu { font-size:20px; line-height:1; padding:6px 10px; }

    /* side list overlay */
    #sideList{
      position:absolute; top:0; left:0; width:320px; height:100%;
      background:rgba(12,16,22,0.85);
      box-shadow:4px 0 30px rgba(0,0,0,0.6); overflow-y:auto; padding:12px;
      transform:translateX(-100%); transition:transform .25s ease;
      z-index:50;
    }
    #sideList.open{ transform:translateX(0); }

    #sideList .side-item {
      all: unset;
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      color: var(--text);
      margin-bottom: 8px;
      position:relative;
    }
    #sideList .side-item:focus {
      outline: 3px solid rgba(29,185,84,0.22);
      background: rgba(255,255,255,0.08);
    }
    #sideList .side-item.active {
      background: rgba(29,185,84,0.2);
    }
    #sideList .side-item .logo {
      width: 56px;
      height: 34px;
      flex: 0 0 56px;
      background: rgba(255,255,255,0.1);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    #sideList .side-item .logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    #sideList .side-item .ch-name {
      font-size: 14px;
      color: #e7eef9;
      line-height: 1.2;
    }
    #sideList .side-item .ch-number {
      font-weight: 700;
      color: var(--accent);
      margin-right: 6px;
    }

    /* number OSD */
    #numOSD {
      position:absolute;
      top:50%; left:50%;
      transform:translate(-50%,-50%);
      font-size:64px;
      font-weight:700;
      color:#fff;
      background:rgba(0,0,0,0.6);
      padding:20px 40px;
      border-radius:12px;
      display:none;
      z-index:100;
    }

    footer{position:fixed; right:18px; bottom:18px; color:var(--muted); font-size:13px}
    @media (max-width:700px){
      #sideList{ width:260px }
    }
  </style>
</head>
<body>
  <!-- Player only -->
  <div id="playerWrap">
    <div id="videoContainer">
      <video id="player" controls playsinline></video>

      <div class="overlay">
        <div class="logo"><img id="curLogo" src="" alt="logo"></div>
        <div class="current-info">
          <div class="title" id="curTitle">Channel</div>
          <div class="num" id="curNumber">#0</div>
        </div>
      </div>

      <div class="controls">
        <button id="btnMenu" class="btn">⋮</button>
      </div>

      <!-- Side channel list -->
      <div id="sideList" aria-hidden="true" role="listbox"></div>

      <!-- Number OSD -->
      <div id="numOSD"></div>
    </div>
  </div>

  <footer>
    Controls: Left / ⋮ — Show List | Up/Down — Navigate | Enter — Select | Right — Hide List | Numbers — Jump to Channel | Esc — Clear
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.0/dist/hls.min.js"></script>
  <script>
    let channels = [];
    let curIndex = -1;
    let hls = null;

    const player = document.getElementById('player');
    const curTitle = document.getElementById('curTitle');
    const curNumber = document.getElementById('curNumber');
    const curLogo = document.getElementById('curLogo');
    const sideList = document.getElementById('sideList');
    const numOSD = document.getElementById('numOSD');
    const btnMenu = document.getElementById('btnMenu');

    function parseM3U(text){
      channels = [];
      const lines = text.split(/\r?\n/);
      let lastMeta = '';
      let num = 1;
      for(const raw of lines){
        const line = (raw||'').trim();
        if(!line) continue;
        if(line.startsWith('#EXTINF')) lastMeta = line;
        else if(!line.startsWith('#')){
          let url = line;
          let title = url.split('/').pop() || ('Channel '+num);
          let logo = '';
          if(lastMeta){
            const comma = lastMeta.indexOf(',');
            if(comma > -1) title = lastMeta.slice(comma+1).trim();
            const m = lastMeta.match(/tvg-logo\s*=\s*"([^"]+)"/i);
            if(m) logo = m[1];
          }
          channels.push({num, title, url, logo});
          num++; lastMeta = '';
        }
      }
    }

    function renderSideList(){
      sideList.innerHTML = '';
      channels.forEach((ch, idx) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'side-item';
        btn.dataset.index = idx;
        btn.innerHTML = `
          <div class="logo"><img src="${ch.logo||''}" alt="logo" onerror="this.style.opacity=.25"></div>
          <div style="display:flex;flex-direction:column;flex:1;align-items:flex-start">
            <div style="display:flex;align-items:center">
              <span class="ch-number">${ch.num}</span>
              <span class="ch-name" style="margin-left:6px">${ch.title}</span>
            </div>
          </div>
        `;
        btn.addEventListener('click', ()=> {
          openChannel(idx);
          hideSideList();
        });
        sideList.appendChild(btn);
      });
      refreshSideActive();
    }

    function loadStream(url){
      if(hls){ try{hls.destroy();}catch(e){} hls=null; }
      if(player.canPlayType('application/vnd.apple.mpegurl')){
        player.src = url;
      } else if(window.Hls && Hls.isSupported()){
        hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(player);
      } else {
        player.src = url;
      }
      player.play().catch(()=>{});
    }

    function openChannel(index){
      if(index<0 || index>=channels.length) return;
      curIndex = index;
      const ch = channels[index];
      curTitle.textContent = ch.title;
      curNumber.textContent = '#'+ch.num;
      curLogo.src = ch.logo||'';
      loadStream(ch.url);
      refreshSideActive();
      hideNumOSD();
    }

    function showSideList(){
      renderSideList();
      sideList.classList.add('open');
      sideList.setAttribute('aria-hidden','false');
      const focusIdx = (curIndex >= 0) ? curIndex : 0;
      const btn = sideList.querySelector(`button[data-index="${focusIdx}"]`);
      if(btn) btn.focus();
      refreshSideActive();
    }
    function hideSideList(){
      sideList.classList.remove('open');
      sideList.setAttribute('aria-hidden','true');
    }
    function refreshSideActive(){
      const items = sideList.querySelectorAll('button.side-item');
      items.forEach(it => {
        const idx = parseInt(it.dataset.index, 10);
        it.classList.toggle('active', idx === curIndex);
      });
    }

    sideList.addEventListener('keydown', (ev)=>{
      if(!sideList.classList.contains('open')) return;
      const items = Array.from(sideList.querySelectorAll('button.side-item'));
      if(!items.length) return;

      if(ev.key === 'ArrowUp' || ev.key === 'ArrowDown'){
        ev.preventDefault();
        let current = items.indexOf(document.activeElement);
        if(current === -1) current = 0;
        if(ev.key === 'ArrowUp') current = Math.max(0, current-1);
        if(ev.key === 'ArrowDown') current = Math.min(items.length-1, current+1);
        items[current].focus();
      }
      if(ev.key === 'Enter'){
        ev.preventDefault();
        const idx = parseInt(document.activeElement.dataset.index,10);
        openChannel(idx);
        hideSideList();
      }
      if(ev.key === 'ArrowRight' || ev.key === 'Escape'){ 
        ev.preventDefault(); 
        hideSideList(); 
      }
    });

    window.addEventListener('keydown', (e)=>{
      if(!channels.length) return;
      if(sideList.classList.contains('open')) return;
      if(e.key==='ArrowLeft'){ e.preventDefault(); showSideList(); }
      else if(e.key==='ArrowRight'){ e.preventDefault(); hideSideList(); }
    });

    // Three-dot menu button toggles side list
    btnMenu.addEventListener("click", () => {
      if (sideList.classList.contains("open")) {
        hideSideList();
      } else {
        showSideList();
      }
    });

    // Number input channel change with OSD
    let numBuffer = "";
    let numTimeout = null;

    function showNumOSD() {
      numOSD.textContent = numBuffer;
      numOSD.style.display = "block";
    }
    function hideNumOSD() {
      numBuffer = "";
      numOSD.style.display = "none";
    }

    function handleNumberInput(digit) {
      numBuffer += digit;
      showNumOSD();

      if (numTimeout) clearTimeout(numTimeout);

      numTimeout = setTimeout(() => {
        jumpToChannel();
      }, 2000);
    }

    function jumpToChannel() {
      if (!numBuffer) return;
      const chNum = parseInt(numBuffer, 10);
      const chIndex = channels.findIndex(ch => ch.num === chNum);
      if (chIndex !== -1) {
        openChannel(chIndex);
      }
      hideNumOSD();
    }

    window.addEventListener("keydown", (e) => {
      if (e.key >= "0" && e.key <= "9") {
        e.preventDefault();
        handleNumberInput(e.key);
      } else if (e.key === "Enter" && numBuffer) {
        e.preventDefault();
        jumpToChannel();
      }
    });

    // Auto load tv.m3u if present
    async function autoLoadPlaylist() {
      try {
        const res = await fetch("tv.m3u");
        if (!res.ok) throw new Error("tv.m3u not found");
        const text = await res.text();
        parseM3U(text);
        if (channels.length) openChannel(0);
      } catch (err) {
        console.log("No tv.m3u found, please load manually.");
      }
    }
    autoLoadPlaylist();
  </script>
</body>
</html>
